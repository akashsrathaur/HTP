# ðŸš€ Complete Deployment Guide - Render + Netlify + PostgreSQL

## Current Situation
You have deployed the prototype, but there's no database connected, so data is lost on restart. This guide will help you add PostgreSQL and redeploy properly.

---

## ðŸ“‹ Prerequisites Checklist

- [ ] GitHub repository with latest code
- [ ] Render account (free tier)
- [ ] Netlify account (free tier)
- [ ] 30 minutes of time

---

## Part 1: Deploy Backend to Render with PostgreSQL

### Step 1: Create PostgreSQL Database on Render

1. **Go to Render Dashboard**: https://dashboard.render.com

2. **Click "New +"** â†’ **"PostgreSQL"**

3. **Configure Database**:
   - **Name**: `vid-system-db`
   - **Database**: `vid_system`
   - **User**: `viduser`
   - **Region**: Choose closest to you (e.g., Oregon, Singapore)
   - **Plan**: **Free** (0.1 GB storage, expires after 90 days)

4. **Click "Create Database"**

5. **Wait for database to be ready** (takes 1-2 minutes)

6. **Copy the Internal Database URL**:
   - Go to your database page
   - Find "Internal Database URL" (looks like: `postgresql://viduser:password@dpg-xxxxx/vid_system`)
   - **Copy this entire URL** - you'll need it in Step 3

---

### Step 2: Update Your Code for PostgreSQL

**Option A: Quick Update (Recommended)**

Update `backend/config.py` line 16:

```python
# Change from:
default="sqlite+aiosqlite:///./vid_system.db"

# To:
default="postgresql+asyncpg://viduser:password@localhost/vid_system"
```

**Option B: Use Environment Variable (Better for Production)**

Keep the code as is - we'll set the DATABASE_URL in Render's environment variables.

---

### Step 3: Deploy/Update Backend Web Service

#### If You Already Have a Web Service Deployed:

1. **Go to your existing Web Service** on Render

2. **Click "Environment"** tab

3. **Add/Update Environment Variable**:
   - **Key**: `DATABASE_URL`
   - **Value**: Paste the Internal Database URL from Step 1
   - Example: `postgresql+asyncpg://viduser:abc123@dpg-xxxxx-a.oregon-postgres.render.com/vid_system`

4. **Ensure these environment variables exist**:
   ```
   DATABASE_URL=postgresql+asyncpg://viduser:password@dpg-xxxxx/vid_system
   JWT_SECRET_KEY=<auto-generated or your own>
   HMAC_SECRET_KEY=<auto-generated or your own>
   VID_EXPIRY_MINUTES=60
   VID_USAGE_LIMIT=1
   CORS_ORIGINS=*
   ```

5. **Click "Save Changes"**

6. **Render will automatically redeploy** - wait 2-3 minutes

7. **Check deployment logs** for any errors

#### If You Need to Create New Web Service:

1. **Click "New +"** â†’ **"Web Service"**

2. **Connect GitHub Repository**: `akashsrathaur/HTP`

3. **Configure Service**:
   - **Name**: `vid-system-backend`
   - **Region**: Same as your database
   - **Branch**: `main`
   - **Root Directory**: Leave empty
   - **Runtime**: `Python 3`
   - **Build Command**: `cd backend && pip install -r requirements.txt`
   - **Start Command**: `cd backend && uvicorn main:app --host 0.0.0.0 --port $PORT`

4. **Plan**: **Free**

5. **Environment Variables** - Add these:
   ```
   DATABASE_URL=<paste Internal Database URL from Step 1>
   JWT_SECRET_KEY=<click "Generate" button>
   HMAC_SECRET_KEY=<click "Generate" button>
   VID_EXPIRY_MINUTES=60
   VID_USAGE_LIMIT=1
   CORS_ORIGINS=*
   ```

6. **Click "Create Web Service"**

7. **Wait for deployment** (3-5 minutes)

---

### Step 4: Verify Backend Deployment

1. **Get your backend URL**: `https://vid-system-backend.onrender.com` (or similar)

2. **Test health endpoint**:
   - Open: `https://vid-system-backend.onrender.com/health`
   - Should return: `{"status":"healthy"}`

3. **Test API docs**:
   - Open: `https://vid-system-backend.onrender.com/docs`
   - Should show interactive API documentation

4. **If you see errors**:
   - Check "Logs" tab in Render
   - Look for database connection errors
   - Verify DATABASE_URL is correct

---

## Part 2: Deploy Frontend to Netlify

### Step 5: Update Frontend API URL

**IMPORTANT**: Update `frontend/app.js` line 6:

```javascript
// Change from:
const API_BASE_URL = 'http://10.12.86.113:8000';

// To (use your actual Render backend URL):
const API_BASE_URL = 'https://vid-system-backend.onrender.com';
```

**Commit and push this change**:
```bash
git add frontend/app.js
git commit -m "Update API URL for production"
git push
```

---

### Step 6: Deploy to Netlify

#### Option A: Drag & Drop (Easiest)

1. **Go to**: https://app.netlify.com/drop

2. **Drag the `frontend` folder** from your computer to the drop zone

3. **Wait for upload** (10-20 seconds)

4. **Get your URL**: `https://random-name-123456.netlify.app`

5. **Done!** Your frontend is live

#### Option B: GitHub Integration (Recommended for Updates)

1. **Go to**: https://app.netlify.com

2. **Click "Add new site"** â†’ **"Import an existing project"**

3. **Connect to GitHub**: Authorize Netlify

4. **Select repository**: `akashsrathaur/HTP`

5. **Configure build settings**:
   - **Base directory**: `frontend`
   - **Build command**: Leave empty (static site)
   - **Publish directory**: `frontend`

6. **Click "Deploy site"**

7. **Wait for deployment** (30-60 seconds)

8. **Get your URL**: `https://random-name-123456.netlify.app`

---

### Step 7: Update CORS on Backend

1. **Go back to Render** â†’ Your Web Service

2. **Click "Environment"** tab

3. **Update `CORS_ORIGINS`**:
   ```
   CORS_ORIGINS=https://your-netlify-url.netlify.app,https://vid-system-backend.onrender.com
   ```
   Replace `your-netlify-url` with your actual Netlify URL

4. **Save** - Render will redeploy

---

## Part 3: Final Testing

### Step 8: Test Complete Flow

1. **Open your Netlify URL**: `https://your-site.netlify.app`

2. **Register a new account**:
   - Name: Test User
   - Email: test@example.com
   - Password: testpass123

3. **Verify identity** (simulated):
   - Aadhaar: 123456789012
   - OTP: 123456
   - PAN: ABCDE1234F

4. **Generate VID**:
   - Should create a 12-digit VID
   - QR code should appear

5. **Test verification**:
   - Go to verify page
   - Enter the VID
   - Should show verification status

6. **Test persistence**:
   - Logout and login again
   - Your data should still be there!
   - VIDs should be saved

---

## ðŸŽ¯ Quick Deployment Checklist

Use this checklist to deploy step-by-step:

### Backend (Render)
- [ ] Create PostgreSQL database on Render
- [ ] Copy Internal Database URL
- [ ] Update/Create Web Service
- [ ] Set DATABASE_URL environment variable
- [ ] Set JWT_SECRET_KEY (generate)
- [ ] Set HMAC_SECRET_KEY (generate)
- [ ] Set other environment variables
- [ ] Wait for deployment
- [ ] Test /health endpoint
- [ ] Test /docs endpoint

### Frontend (Netlify)
- [ ] Update API_BASE_URL in frontend/app.js
- [ ] Commit and push changes
- [ ] Deploy to Netlify (drag & drop or GitHub)
- [ ] Get Netlify URL
- [ ] Update CORS_ORIGINS on Render backend
- [ ] Wait for backend redeploy

### Testing
- [ ] Open Netlify URL
- [ ] Register new account
- [ ] Verify identity
- [ ] Generate VID
- [ ] Test verification
- [ ] Logout and login (test persistence)

---

## ðŸš¨ Troubleshooting

### Backend Issues

**Error: "Database connection failed"**
- Check DATABASE_URL is correct
- Ensure it starts with `postgresql+asyncpg://`
- Verify database is running on Render

**Error: "Module not found"**
- Check requirements.txt includes `asyncpg>=0.29.0`
- Redeploy to reinstall dependencies

**Error: "Port already in use"**
- Render handles this automatically
- Make sure start command uses `$PORT` variable

### Frontend Issues

**Error: "Failed to fetch"**
- Check API_BASE_URL in app.js
- Ensure it's your Render backend URL (https://)
- Check CORS_ORIGINS on backend includes your Netlify URL

**Error: "CORS policy"**
- Update CORS_ORIGINS on Render
- Include both http and https versions
- Redeploy backend after updating

### Database Issues

**Data disappears after restart**
- You're still using SQLite - check DATABASE_URL
- Should be PostgreSQL URL, not sqlite://

**Can't connect to database**
- Use Internal Database URL, not External
- Ensure backend and database are in same region

---

## ðŸ“Š Expected URLs

After deployment, you should have:

| Service | URL | Purpose |
|---------|-----|---------|
| Backend API | `https://vid-system-backend.onrender.com` | API endpoints |
| API Docs | `https://vid-system-backend.onrender.com/docs` | Interactive docs |
| Frontend | `https://your-site.netlify.app` | User interface |
| Database | Internal Render URL | PostgreSQL storage |

---

## ðŸ’° Cost Breakdown

| Service | Plan | Cost | Limits |
|---------|------|------|--------|
| Render Web Service | Free | $0 | 750 hrs/month, sleeps after 15min |
| Render PostgreSQL | Free | $0 | 0.1 GB, 90 days trial |
| Netlify | Free | $0 | 100 GB bandwidth/month |
| **Total** | | **$0/month** | |

**Note**: After 90 days, Render PostgreSQL becomes $7/month. You can:
- Migrate to another free PostgreSQL (Supabase, Neon)
- Upgrade to paid plan
- Export and redeploy

---

## ðŸ”„ Updating Your Deployment

### To Update Backend:
1. Make changes locally
2. Commit and push to GitHub
3. Render auto-deploys (if connected to GitHub)
4. Or manually redeploy from Render dashboard

### To Update Frontend:
1. Make changes locally
2. Update frontend/app.js if needed
3. Commit and push
4. Netlify auto-deploys (if GitHub connected)
5. Or drag & drop new frontend folder

---

## âœ… Success Criteria

Your deployment is successful when:

âœ… Backend health check returns `{"status":"healthy"}`
âœ… API docs are accessible
âœ… Frontend loads without errors
âœ… Can register and login
âœ… Can verify identity
âœ… Can generate VIDs
âœ… Data persists after logout/login
âœ… VIDs work from different devices
âœ… QR codes scan correctly

---

## ðŸŽ‰ You're Done!

Your Privacy-Preserving Virtual Identity System is now:
- âœ… Deployed to production
- âœ… Using PostgreSQL (persistent data)
- âœ… Accessible from anywhere
- âœ… Free to use
- âœ… Secure and scalable

Share your Netlify URL with others to let them use the system!

---

## ðŸ“ž Need Help?

If you encounter issues:
1. Check Render logs (Logs tab)
2. Check browser console (F12)
3. Verify all environment variables
4. Ensure DATABASE_URL is PostgreSQL, not SQLite
5. Test each endpoint individually

**Common fix**: Redeploy both services after making changes!
